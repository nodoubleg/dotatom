var author_regex = /([^<]+)<([^>]+)>/;
var headers = {
    'Author': function Author(current_commit, author) {
        var capture = author_regex.exec(author);
        if (capture) {
            current_commit.author_name = capture[1].trim();
            current_commit.author_email = capture[2].trim();
        } else {
            current_commit.author_name = author;
        }
    },

    'Commit': function Commit(current_commit, author) {
        var capture = author_regex.exec(author);
        if (capture) {
            current_commit.committer_name = capture[1].trim();
            current_commit.committer_email = capture[2].trim();
        } else {
            current_commit.committer_name = author;
        }
    },

    'AuthorDate': function AuthorDate(current_commit, date) {
        current_commit.author_date = date;
    },

    'CommitDate': function CommitDate(current_commit, date) {
        current_commit.commit_date = date;
    },

    'Reflog': function Reflog(current_commit, data) {
        current_commit.reflog_name = data.substring(0, data.indexOf(' '));
        var author = data.substring(data.indexOf(' ') + 2, data.length - 1);
        var capture = author_regex.exec(author);
        if (capture) {
            current_commit.reflog_author_name = capture[1].trim();
            current_commit.reflog_author_email = capture[2].trim();
        } else {
            current_commit.reflog_author_name = author;
        }
    } };

var parse_git_log = function parse_git_log(data) {
    var commits = [];
    var current_commit;
    var temp_file_change = [];
    var parse_commit_line = function parse_commit_line(row) {
        if (!row.trim()) return;
        current_commit = { refs: [], file_line_diffs: [] };
        var ss = row.split('(');
        var sha1s = ss[0].split(' ').slice(1).filter(function (sha1) {
            return sha1 && sha1.length;
        });
        current_commit.sha1 = sha1s[0];
        current_commit.parents = sha1s.slice(1);
        if (ss[1]) {
            var refs = ss[1].slice(0, ss[1].length - 1);
            current_commit.refs = refs.split(', ');
        }
        commits.push(current_commit);
        parser = parse_header_line;
    };
    var parse_header_line = function parse_header_line(row) {
        if (row.trim() == '') {
            parser = parse_commit_message;
        } else {
            for (var key in headers) {
                if (row.indexOf(key + ': ') == 0) {
                    headers[key](current_commit, row.slice((key + ': ').length).trim());
                    return;
                }
            }
        }
    };
    var parse_commit_message = function parse_commit_message(row, index) {
        if (/:[\d]+\s[\d]+\s[\d|\w]+.../g.test(rows[index + 1])) {
            //if (/[\d-]+\t[\d-]+\t.+/g.test(rows[index + 1])) {
            parser = parse_file_changes;
            return;
        }
        if (rows[index + 1] && rows[index + 1].indexOf('commit ') == 0) {
            parser = parse_commit_line;
            return;
        }
        if (current_commit.message) current_commit.message += '\n';else current_commit.message = '';
        current_commit.message += row.trim();
    };
    var parse_file_changes = function parse_file_changes(row, index) {
        if (rows.length === index + 1 || rows[index + 1] && rows[index + 1].indexOf('commit ') === 0) {
            var total = [0, 0, 'Total'];
            for (var n = 0; n < current_commit.file_line_diffs.length; n++) {
                var file_line_diff = current_commit.file_line_diffs[n];
                if (!isNaN(parseInt(file_line_diff[0], 10))) {
                    total[0] += file_line_diff[0] = parseInt(file_line_diff[0], 10);
                }
                if (!isNaN(parseInt(file_line_diff[1], 10))) {
                    total[1] += file_line_diff[1] = parseInt(file_line_diff[1], 10);
                }
            }
            current_commit.file_line_diffs.splice(0, 0, total);
            parser = parse_commit_line;
            return;
        }
        if (row[0] == ':') {
            var val = row[row.lastIndexOf('... ') + 4];
            temp_file_change.push(val);
        } else {
            current_commit.file_line_diffs.push(row.split('\t').concat(temp_file_change.shift()));
        }
    };
    var parser = parse_commit_line;
    var rows = data.split('\n');
    rows.forEach(function (row, index) {
        parser(row, index);
    });

    commits.forEach(function (commit) {
        commit.message = typeof commit.message === 'string' ? commit.message.trim() : '';
    });
    return commits;
};

module.exports = parse_git_log;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9nbWFzb24vLmF0b20vcGFja2FnZXMvZ2l0LWxvZy9saWIvbG9ncGFyc2VyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUksWUFBWSxHQUFHLGtCQUFrQixDQUFDO0FBQ3RDLElBQUksT0FBTyxHQUFHO0FBQ1YsWUFBUSxFQUFFLGdCQUFTLGNBQWMsRUFBRSxNQUFNLEVBQUU7QUFDdkMsWUFBSSxPQUFPLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUN4QyxZQUFHLE9BQU8sRUFBRTtBQUNSLDBCQUFjLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztBQUMvQywwQkFBYyxDQUFDLFlBQVksR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDbkQsTUFBTTtBQUNILDBCQUFjLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQztTQUN2QztLQUNKOztBQUVELFlBQVEsRUFBRSxnQkFBUyxjQUFjLEVBQUUsTUFBTSxFQUFFO0FBQ3ZDLFlBQUksT0FBTyxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDeEMsWUFBSSxPQUFPLEVBQUU7QUFDVCwwQkFBYyxDQUFDLGNBQWMsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7QUFDbEQsMEJBQWMsQ0FBQyxlQUFlLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1NBQ3RELE1BQ0k7QUFDRCwwQkFBYyxDQUFDLGNBQWMsR0FBRyxNQUFNLENBQUM7U0FDMUM7S0FDSjs7QUFFRCxnQkFBWSxFQUFFLG9CQUFTLGNBQWMsRUFBRSxJQUFJLEVBQUU7QUFDekMsc0JBQWMsQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO0tBQ3JDOztBQUVELGdCQUFZLEVBQUUsb0JBQVMsY0FBYyxFQUFFLElBQUks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Q0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztTQUN6RjtLQUNKLENBQUE7QUFDRCxRQUFJLE1BQU0sR0FBRyxpQkFBaUIsQ0FBQztBQUMvQixRQUFJLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzVCLFFBQUksQ0FBQyxPQUFPLENBQUMsVUFBUyxHQUFHLEVBQUUsS0FBSyxFQUFFO0FBQzlCLGNBQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7S0FDdEIsQ0FBQyxDQUFDOztBQUVILFdBQU8sQ0FBQyxPQUFPLENBQUMsVUFBUyxNQUFNLEVBQUU7QUFBRSxjQUFNLENBQUMsT0FBTyxHQUFHLEFBQUMsT0FBTyxNQUFNLENBQUMsT0FBTyxLQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsQ0FBQztLQUFFLENBQUMsQ0FBQztBQUMxSCxXQUFPLE9BQU8sQ0FBQztDQUNsQixDQUFDOztBQUVGLE1BQU0sQ0FBQyxPQUFPLEdBQUcsYUFBYSxDQUFDIiwiZmlsZSI6Ii9Vc2Vycy9nbWFzb24vLmF0b20vcGFja2FnZXMvZ2l0LWxvZy9saWIvbG9ncGFyc2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGF1dGhvcl9yZWdleCA9IC8oW148XSspPChbXj5dKyk+LztcbnZhciBoZWFkZXJzID0ge1xuICAgICdBdXRob3InOiBmdW5jdGlvbihjdXJyZW50X2NvbW1pdCwgYXV0aG9yKSB7XG4gICAgICAgIHZhciBjYXB0dXJlID0gYXV0aG9yX3JlZ2V4LmV4ZWMoYXV0aG9yKTtcbiAgICAgICAgaWYoY2FwdHVyZSkge1xuICAgICAgICAgICAgY3VycmVudF9jb21taXQuYXV0aG9yX25hbWUgPSBjYXB0dXJlWzFdLnRyaW0oKTtcbiAgICAgICAgICAgIGN1cnJlbnRfY29tbWl0LmF1dGhvcl9lbWFpbCA9IGNhcHR1cmVbMl0udHJpbSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY3VycmVudF9jb21taXQuYXV0aG9yX25hbWUgPSBhdXRob3I7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgJ0NvbW1pdCc6IGZ1bmN0aW9uKGN1cnJlbnRfY29tbWl0LCBhdXRob3IpIHtcbiAgICAgICAgdmFyIGNhcHR1cmUgPSBhdXRob3JfcmVnZXguZXhlYyhhdXRob3IpO1xuICAgICAgICBpZiAoY2FwdHVyZSkge1xuICAgICAgICAgICAgY3VycmVudF9jb21taXQuY29tbWl0dGVyX25hbWUgPSBjYXB0dXJlWzFdLnRyaW0oKTtcbiAgICAgICAgICAgIGN1cnJlbnRfY29tbWl0LmNvbW1pdHRlcl9lbWFpbCA9IGNhcHR1cmVbMl0udHJpbSgpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgY3VycmVudF9jb21taXQuY29tbWl0dGVyX25hbWUgPSBhdXRob3I7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgJ0F1dGhvckRhdGUnOiBmdW5jdGlvbihjdXJyZW50X2NvbW1pdCwgZGF0ZSkge1xuICAgICAgICBjdXJyZW50X2NvbW1pdC5hdXRob3JfZGF0ZSA9IGRhdGU7XG4gICAgfSxcblxuICAgICdDb21taXREYXRlJzogZnVuY3Rpb24oY3VycmVudF9jb21taXQsIGRhdGUpIHtcbiAgICAgICAgY3VycmVudF9jb21taXQuY29tbWl0X2RhdGUgPSBkYXRlO1xuICAgIH0sXG5cbiAgICAnUmVmbG9nJzogZnVuY3Rpb24oY3VycmVudF9jb21taXQsIGRhdGEpIHtcbiAgICAgICAgY3VycmVudF9jb21taXQucmVmbG9nX25hbWUgPSBkYXRhLnN1YnN0cmluZygwLCBkYXRhLmluZGV4T2YoJyAnKSk7XG4gICAgICAgIHZhciBhdXRob3IgPSBkYXRhLnN1YnN0cmluZyhkYXRhLmluZGV4T2YoJyAnKSArIDIsIGRhdGEubGVuZ3RoIC0gMSk7XG4gICAgICAgIHZhciBjYXB0dXJlID0gYXV0aG9yX3JlZ2V4LmV4ZWMoYXV0aG9yKTtcbiAgICAgICAgaWYgKGNhcHR1cmUpIHtcbiAgICAgICAgICAgIGN1cnJlbnRfY29tbWl0LnJlZmxvZ19hdXRob3JfbmFtZSA9IGNhcHR1cmVbMV0udHJpbSgpO1xuICAgICAgICAgICAgY3VycmVudF9jb21taXQucmVmbG9nX2F1dGhvcl9lbWFpbCA9IGNhcHR1cmVbMl0udHJpbSgpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgY3VycmVudF9jb21taXQucmVmbG9nX2F1dGhvcl9uYW1lID0gYXV0aG9yO1xuICAgICAgICB9XG4gICAgfSxcbn07XG5cbnZhciBwYXJzZV9naXRfbG9nID0gZnVuY3Rpb24oZGF0YSkge1xuICAgIHZhciBjb21taXRzID0gW107XG4gICAgdmFyIGN1cnJlbnRfY29tbWl0O1xuICAgIHZhciB0ZW1wX2ZpbGVfY2hhbmdlID0gW107XG4gICAgdmFyIHBhcnNlX2NvbW1pdF9saW5lID0gZnVuY3Rpb24ocm93KSB7XG4gICAgICAgIGlmICghcm93LnRyaW0oKSkgcmV0dXJuO1xuICAgICAgICBjdXJyZW50X2NvbW1pdCA9IHsgcmVmczogW10sIGZpbGVfbGluZV9kaWZmczogW10gfTtcbiAgICAgICAgdmFyIHNzID0gcm93LnNwbGl0KCcoJyk7XG4gICAgICAgIHZhciBzaGExcyA9IHNzWzBdLnNwbGl0KCcgJykuc2xpY2UoMSkuZmlsdGVyKGZ1bmN0aW9uKHNoYTEpIHsgcmV0dXJuIHNoYTEgJiYgc2hhMS5sZW5ndGg7IH0pO1xuICAgICAgICBjdXJyZW50X2NvbW1pdC5zaGExID0gc2hhMXNbMF07XG4gICAgICAgIGN1cnJlbnRfY29tbWl0LnBhcmVudHMgPSBzaGExcy5zbGljZSgxKTtcbiAgICAgICAgaWYgKHNzWzFdKSB7XG4gICAgICAgICAgICB2YXIgcmVmcyA9IHNzWzFdLnNsaWNlKDAsIHNzWzFdLmxlbmd0aCAtIDEpO1xuICAgICAgICAgICAgY3VycmVudF9jb21taXQucmVmcyA9IHJlZnMuc3BsaXQoJywgJyk7XG4gICAgICAgIH1cbiAgICAgICAgY29tbWl0cy5wdXNoKGN1cnJlbnRfY29tbWl0KTtcbiAgICAgICAgcGFyc2VyID0gcGFyc2VfaGVhZGVyX2xpbmU7XG4gICAgfVxuICAgIHZhciBwYXJzZV9oZWFkZXJfbGluZSA9IGZ1bmN0aW9uKHJvdykge1xuICAgICAgICBpZiAocm93LnRyaW0oKSA9PSAnJykge1xuICAgICAgICAgICAgcGFyc2VyID0gcGFyc2VfY29tbWl0X21lc3NhZ2U7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gaGVhZGVycykge1xuICAgICAgICAgICAgICAgIGlmIChyb3cuaW5kZXhPZihrZXkgKyAnOiAnKSA9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGhlYWRlcnNba2V5XShjdXJyZW50X2NvbW1pdCwgcm93LnNsaWNlKChrZXkgKyAnOiAnKS5sZW5ndGgpLnRyaW0oKSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICB2YXIgcGFyc2VfY29tbWl0X21lc3NhZ2UgPSBmdW5jdGlvbihyb3csIGluZGV4KSB7XG4gICAgICAgIGlmKC86W1xcZF0rXFxzW1xcZF0rXFxzW1xcZHxcXHddKy4uLi9nLnRlc3Qocm93c1tpbmRleCArIDFdKSkge1xuICAgICAgICAvL2lmICgvW1xcZC1dK1xcdFtcXGQtXStcXHQuKy9nLnRlc3Qocm93c1tpbmRleCArIDFdKSkge1xuICAgICAgICAgICAgcGFyc2VyID0gcGFyc2VfZmlsZV9jaGFuZ2VzO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyb3dzW2luZGV4ICsgMV0gJiYgcm93c1tpbmRleCArIDFdLmluZGV4T2YoJ2NvbW1pdCAnKSA9PSAwKSB7XG4gICAgICAgICAgICBwYXJzZXIgPSBwYXJzZV9jb21taXRfbGluZTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY3VycmVudF9jb21taXQubWVzc2FnZSlcbiAgICAgICAgICAgIGN1cnJlbnRfY29tbWl0Lm1lc3NhZ2UgKz0gJ1xcbic7XG4gICAgICAgIGVsc2UgY3VycmVudF9jb21taXQubWVzc2FnZSA9ICcnO1xuICAgICAgICAgICAgY3VycmVudF9jb21taXQubWVzc2FnZSArPSByb3cudHJpbSgpO1xuICAgIH1cbiAgICB2YXIgcGFyc2VfZmlsZV9jaGFuZ2VzID0gZnVuY3Rpb24ocm93LCBpbmRleCkge1xuICAgICAgICBpZiAocm93cy5sZW5ndGggPT09IGluZGV4ICsgMSB8fCByb3dzW2luZGV4ICsgMV0gJiYgcm93c1tpbmRleCArIDFdLmluZGV4T2YoJ2NvbW1pdCAnKSA9PT0gMCkge1xuICAgICAgICAgICAgdmFyIHRvdGFsID0gWzAsIDAsICdUb3RhbCddO1xuICAgICAgICAgICAgZm9yICh2YXIgbiA9IDA7IG4gPCBjdXJyZW50X2NvbW1pdC5maWxlX2xpbmVfZGlmZnMubGVuZ3RoOyBuKyspIHtcbiAgICAgICAgICAgICAgICB2YXIgZmlsZV9saW5lX2RpZmYgPSBjdXJyZW50X2NvbW1pdC5maWxlX2xpbmVfZGlmZnNbbl07XG4gICAgICAgICAgICAgICAgaWYgKCFpc05hTihwYXJzZUludChmaWxlX2xpbmVfZGlmZlswXSwgMTApKSkge1xuICAgICAgICAgICAgICAgICAgICB0b3RhbFswXSArPSBmaWxlX2xpbmVfZGlmZlswXSA9IHBhcnNlSW50KGZpbGVfbGluZV9kaWZmWzBdLCAxMCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICghaXNOYU4ocGFyc2VJbnQoZmlsZV9saW5lX2RpZmZbMV0sIDEwKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdG90YWxbMV0gKz0gZmlsZV9saW5lX2RpZmZbMV0gPSBwYXJzZUludChmaWxlX2xpbmVfZGlmZlsxXSwgMTApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGN1cnJlbnRfY29tbWl0LmZpbGVfbGluZV9kaWZmcy5zcGxpY2UoMCwwLCB0b3RhbCk7XG4gICAgICAgICAgICBwYXJzZXIgPSBwYXJzZV9jb21taXRfbGluZTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZihyb3dbMF0gPT0gJzonKSB7XG4gICAgICAgICAgICB2YXIgdmFsID0gcm93W3Jvdy5sYXN0SW5kZXhPZignLi4uICcpICsgNF07XG4gICAgICAgICAgICB0ZW1wX2ZpbGVfY2hhbmdlLnB1c2godmFsKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGN1cnJlbnRfY29tbWl0LmZpbGVfbGluZV9kaWZmcy5wdXNoKHJvdy5zcGxpdCgnXFx0JykuY29uY2F0KHRlbXBfZmlsZV9jaGFuZ2Uuc2hpZnQoKSkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHZhciBwYXJzZXIgPSBwYXJzZV9jb21taXRfbGluZTtcbiAgICB2YXIgcm93cyA9IGRhdGEuc3BsaXQoJ1xcbicpO1xuICAgIHJvd3MuZm9yRWFjaChmdW5jdGlvbihyb3csIGluZGV4KSB7XG4gICAgICAgIHBhcnNlcihyb3csIGluZGV4KTtcbiAgICB9KTtcblxuICAgIGNvbW1pdHMuZm9yRWFjaChmdW5jdGlvbihjb21taXQpIHsgY29tbWl0Lm1lc3NhZ2UgPSAodHlwZW9mIGNvbW1pdC5tZXNzYWdlKSA9PT0gJ3N0cmluZycgPyBjb21taXQubWVzc2FnZS50cmltKCkgOiAnJzsgfSk7XG4gICAgcmV0dXJuIGNvbW1pdHM7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IHBhcnNlX2dpdF9sb2c7XG4iXX0=