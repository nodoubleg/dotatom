var GitLogView = require("./git-log-class");
var BufferedProcess = require("atom").BufferedProcess;
var LogParser = require("./logparser");
var GitGraph = require("./gitgraph");
var $ = require("atom-space-pen-views").$;

var __bind = function __bind(fn, me) {
    return function () {
        return fn.apply(me, arguments);
    };
};

var safe_tags = function safe_tags(str) {
    return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
};

GitLogView.prototype.initialize = function (repo) {
    var editorFontSize = atom.config.get("editor.fontSize");
    var editorLineHeight = atom.config.get("editor.lineHeight");
    var fontScale = atom.config.get("git-log.fontScale");
    this.font_family = atom.config.get("git-log.fontFamily");
    this.repo = repo;
    this.info_panel.hide();
    this.path = repo.repo_name;

    this.font_size = editorFontSize * fontScale;
    this.line_height = Math.round(this.font_size * editorLineHeight);

    this.get_log();

    //this.resize_started = __bind(this.resize_started, this);
    //this.resize_table = __bind(this.resize_table, this);
    //this.resize_stopped = __bind(this.resize_stopped, this);
    this.hide = __bind(this.info_panel.hide, this);
};

GitLogView.prototype.get_log = function () {
    this.log = null;
    var concat = (function (self) {
        return function (data) {
            if (self.log == null) {
                self.log = "";
            }
            self.log += data;
        };
    })(this);

    var display_log = (function (self) {
        return function (data) {
            self.log_callback();
        };
    })(this);

    var args = ["log", "--decorate=full", "--date=default", "--pretty=fuller", "--all", "--parents", "--numstat", "--topo-order", "--raw"];
    var options = {};
    options.cwd = this.repo.getWorkingDirectory();

    return new BufferedProcess({
        command: "git",
        args: args,
        options: options,
        stdout: concat,
        stderr: function stderr(data) {
            console.log(data.toString());
        },
        exit: display_log
    });
};

GitLogView.prototype.log_callback = function (data) {
    this.parser();

    //this.min_width = Math.floor(this.width()/10);

    this.fill_content();
    /**
    this.on('mousedown', '.resize-handle', (function(self) {
        return function(e) {
            self.resize_started(e);
        };
    })(this));
    **/
    atom.commands.add(".git-log", "core:cancel", (function (self) {
        return function (e) {
            self.info_panel.hide();
        };
    })(this));

    atom.commands.add(".git-log", "core:close", (function (self) {
        return function (e) {
            self.info_panel.hide();
        };
    })(this));

    atom.commands.add(".git-log", "core:move-up", (function (self) {
        return function (e) {
            if (self.previous_line == null || self.previous_line == 1) return;

            var data = self.get_target_line(null, self.previous_line - 1);
            self.handle_scroll(data[0], 1);
            self.select_display_info(data[0], data[1]);
        };
    })(this));

    atom.commands.add(".git-log", "core:move-down", (function (self) {
        return function (e) {
            if (self.previous_line == null || self.previous_line == self.log.length) return;

            var data = self.get_target_line(null, self.previous_line + 1);
            self.handle_scroll(data[0], 0);
            self.select_display_info(data[0], data[1]);
        };
    })(this));
};

GitLogView.prototype.parser = function () {
    this.log = LogParser(this.log);
    var graph = new GitGraph(this.main_panel.graph, this.log, this.line_height, 2);
};

GitLogView.prototype.fill_content = function () {
    var create_main_row = function create_main_row(log) {
        var html = "<tr><td><p> &nbsp;</p></td>";
        html += "<td><p>" + log.message.split("\n")[0] + "</p></td>";
        html += "<td><p>" + log.sha1.slice(0, 7) + "</p></td>";

        var date = log.author_date.split(/ /);

        html += "<td><p>" + date[2] + " " + date[1] + " " + date[4] + " " + date[3].slice(0, 5) + "</p></td>";
        html += "<td><p>" + log.author_name + "</p></td>";
        html += "</tr>";

        return html;
    };

    var set_widths = function set_widths(svg_width) {
        var total = main_panel.width();
        var diff = total - svg_width;

        // allocate widths in this ratio 70:10:10:10
        main_panel.comments.width(diff * 0.7);
        diff = diff * 0.1;
        main_panel.commit.width(diff);
        main_panel.date.width(diff);
        main_panel.author.width(diff);
    };

    var i, len;
    var main_panel = this.main_panel;
    for (i = 0; len = this.log.length, i < len; i++) {
        var log = this.log[i];
        main_panel.body.append(create_main_row(log));
    }

    this.css({
        "font-family": this.font_family,
        "font-size": this.font_size + "px",
        "line-height": this.line_height + "px"
    });

    main_panel.graph.css("top", main_panel.find("thead").height());

    var svg_width = main_panel.graph.width();
    main_panel.find("thead th:first-child").width(svg_width);
    set_widths(svg_width);

    main_panel.body.on("click", "tr", (function (self) {
        return function (e) {
            var data = self.get_target_line(e);
            self.select_display_info(data[0], data[1]);
        };
    })(this));
};

GitLogView.prototype.getTitle = function () {
    return "Git-log: " + this.path;
};

GitLogView.prototype.getURI = function () {
    return "git-log://" + this.path;
};

GitLogView.prototype.onDidChangeTitle = function () {
    return;
};

GitLogView.prototype.onDidChangeModified = function () {
    return;
};

GitLogView.prototype.get_image = function (email) {
    var crypto = require("crypto");
    var base = "http://www.gravatar.com/avatar/";
    return base + crypto.createHash("md5").update(email.toLowerCase().trim()).digest("hex") + "?s=64";
};

GitLogView.prototype.resize_started = function (event) {
    this.pos = {};
    this.pos.pointer_x = event.pageX;
    this.pos.left = $(event.target).position().left;

    this.pos.left_col = $(event.target).parents(".column");
    this.pos.right_col = $(this.pos.left_col.next());

    this.pos.left_width = this.pos.left_col.width();
    this.pos.right_width = this.pos.right_col.width();

    $(document).on("mousemove.git-log", this.resize_table);
    $(document).on("mouseup.git-log", this.resize_stopped);
    return false;
};

GitLogView.prototype.resize_table = function (event) {
    if (!this.pos) return;

    var x = event.pageX - this.pos.pointer_x + this.pos.left;
    this.pos.x = x;

    var inc = this.pos.x - this.pos.left;

    var w = this.pos.left_width + inc;
    var w2 = this.pos.right_width - inc;

    w = Math.max(this.min_width, w);
    w2 = Math.max(this.min_width, w2);

    //this.pos.left_col.width(w + 'px');
    //this.pos.right_col.width(w2 + 'px');

    this.pos.left_col.css("flex-basis", w + "px");
    this.pos.right_col.css("flex-basis", w2 + "px");
    return false;
};

GitLogView.prototype.resize_stopped = function (event) {
    this.pos = null;
    $(document).off("mousemove.git-log", this.resize_table);
    $(document).off("mouseup.git-log", this.resize_stopped);
};

GitLogView.prototype.get_target_line = function (event, line) {
    var line_no, target;
    if (event == null) {
        line_no = line;
        target = this.main_panel.body.find("tr:nth-child(" + line_no + ")");
    } else {
        line_no = $(event.currentTarget).index() + 1;
        target = $(event.currentTarget);
    }
    return [target, line_no];
};

GitLogView.prototype.handle_scroll = function (target, dir) {
    var offset_trigger = 3;
    var line_height = $(target).height() + 2; // accounting for the margin
    offset_trigger = offset_trigger * line_height;
    var window_height = this.main_panel.height();
    // move up
    if (dir == 1) {
        if (target.offset().top < offset_trigger) {
            this.main_panel.scrollTop(this.main_panel.scrollTop() - line_height);
        }
    } else if (dir == 0) {
        if (target.offset().top > window_height - offset_trigger) {
            this.main_panel.scrollTop(this.main_panel.scrollTop() + line_height);
        }
    }
};

GitLogView.prototype.select_display_info = function (target, line_no) {
    if (!this.info_panel.isVisible()) this.info_panel.show();

    this.info_panel.info_data.empty();
    this.info_panel.info_image.empty();
    this.info_panel.body.empty();

    var commit_data = this.log[line_no - 1];

    // background line higlighting
    if (this.previous_line != null) this.main_panel.body.find("tr:nth-child(" + this.previous_line + ")").removeClass("log-highlight");

    this.previous_line = line_no;
    target.addClass("log-highlight");

    this.info_panel.add_content("Commit:", commit_data.sha1 + " [" + commit_data.sha1.slice(0, 7) + "]");
    this.info_panel.add_content("Parents:", commit_data.parents.map(function (str) {
        return str.slice(0, 10);
    }).join(", "));
    this.info_panel.add_content("Author:", commit_data.author_name + " <" + commit_data.author_email + ">");
    var date = commit_data.author_date.split(/ /);
    this.info_panel.add_content("Date:", date[2] + " " + date[1] + " " + date[4] + " " + date[3].slice(0, 8));

    // add committer related information
    if (commit_data.committer_name != commit_data.author_name) {
        this.info_panel.add_content("Committer:", commit_data.committer_name + " <" + commit_data.committer_email + ">");
        date = commit_data.commit_date.split(/ /);
        this.info_panel.add_content("Commit Date:", date[2] + " " + date[1] + " " + date[4] + " " + date[3].slice(0, 8));
    }

    // remove refs/heads or refs/remotes
    if (commit_data.refs.length > 0) this.info_panel.add_content("Labels:", commit_data.refs.map(function (str) {
        return str.replace(/^.*\/(remotes|heads)\//, "");
    }).join(", "));
    this.info_panel.info_data.append("<p>" + safe_tags(commit_data.message).replace(/\n/g, "<br>") + "</p>");
    this.info_panel.info_image.append("<img src=\"" + safe_tags(this.get_image(commit_data.author_email)) + "\"/>");

    if (commit_data.committer_name != commit_data.author_name) {
        this.info_panel.info_image.append("<img src=\"" + safe_tags(this.get_image(commit_data.committer_email)) + "\"/>");
    }

    // fill the file information
    var i, len, temp, status_text;

    var create_row = function create_row(temp) {
        var temp, status_text, index;
        var html = "<tr>";

        if (temp[3] == "A") status_text = "added";else if (temp[3] == "D") status_text = "deleted";else status_text = "modified";
        html += "<td><p>" + status_text + "</p></td>";

        index = temp[2].lastIndexOf("/");
        html += "<td><p>" + temp[2].slice(index + 1) + "</p></td>";
        html += "<td><p>" + (index >= 0 ? temp[2].slice(0, index) : "&nbsp;") + "</p></td>";
        html += "<td><p>" + temp[0] + "</p></td>";
        html += "<td><p>" + temp[1] + "</p></td>";
        html += "</tr>";

        return html;
    };

    this.info_panel.info_file.show();
    if (commit_data.file_line_diffs.length == 0) this.info_panel.info_file.hide();

    var i, len, temp;
    for (i = 1; len = commit_data.file_line_diffs.length, i < len; i++) {
        temp = create_row(commit_data.file_line_diffs[i]);
        this.info_panel.body.append(temp);
    }
};

module.exports = GitLogView;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9nbWFzb24vLmF0b20vcGFja2FnZXMvZ2l0LWxvZy9saWIvZ2l0LWxvZy12aWV3LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQzVDLElBQUksZUFBZSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxlQUFlLENBQUM7QUFDdEQsSUFBSSxTQUFTLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQ3ZDLElBQUksUUFBUSxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUNyQyxJQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxDQUFDLENBQUM7O0FBRTFDLElBQUksTUFBTSxHQUFHLFNBQVQsTUFBTSxDQUFZLEVBQUUsRUFBRSxFQUFFLEVBQUU7QUFDMUIsV0FBTyxZQUFXO0FBQ2QsZUFBTyxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxTQUFTLENBQUMsQ0FBQztLQUNsQyxDQUFDO0NBQ0wsQ0FBQzs7QUFFRixJQUFJLFNBQVMsR0FBRyxTQUFaLFNBQVMsQ0FBWSxHQUFHLEVBQUU7QUFDMUIsV0FBTyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksRUFBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUMsTUFBTSxDQUFDLENBQUU7Q0FDL0UsQ0FBQzs7QUFFRixVQUFVLENBQUMsU0FBUyxDQUFDLFVBQVUsR0FBRyxVQUFTLElBQUksRUFBRTtBQUM3QyxRQUFJLGNBQWMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQ3hELFFBQUksZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUM1RCxRQUFJLFNBQVMsR0FB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cy9naXQtbG9nL2xpYi9naXQtbG9nLXZpZXcuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgR2l0TG9nVmlldyA9IHJlcXVpcmUoXCIuL2dpdC1sb2ctY2xhc3NcIik7XG52YXIgQnVmZmVyZWRQcm9jZXNzID0gcmVxdWlyZShcImF0b21cIikuQnVmZmVyZWRQcm9jZXNzO1xudmFyIExvZ1BhcnNlciA9IHJlcXVpcmUoXCIuL2xvZ3BhcnNlclwiKTtcbnZhciBHaXRHcmFwaCA9IHJlcXVpcmUoXCIuL2dpdGdyYXBoXCIpO1xudmFyICQgPSByZXF1aXJlKFwiYXRvbS1zcGFjZS1wZW4tdmlld3NcIikuJDtcblxudmFyIF9fYmluZCA9IGZ1bmN0aW9uKGZuLCBtZSkge1xuICAgIHJldHVybiBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIGZuLmFwcGx5KG1lLCBhcmd1bWVudHMpO1xuICAgIH07XG59O1xuXG52YXIgc2FmZV90YWdzID0gZnVuY3Rpb24oc3RyKSB7XG4gICAgcmV0dXJuIHN0ci5yZXBsYWNlKC8mL2csJyZhbXA7JykucmVwbGFjZSgvPC9nLCcmbHQ7JykucmVwbGFjZSgvPi9nLCcmZ3Q7JykgO1xufTtcblxuR2l0TG9nVmlldy5wcm90b3R5cGUuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKHJlcG8pIHtcbiAgICB2YXIgZWRpdG9yRm9udFNpemUgPSBhdG9tLmNvbmZpZy5nZXQoJ2VkaXRvci5mb250U2l6ZScpO1xuICAgIHZhciBlZGl0b3JMaW5lSGVpZ2h0ID0gYXRvbS5jb25maWcuZ2V0KCdlZGl0b3IubGluZUhlaWdodCcpO1xuICAgIHZhciBmb250U2NhbGUgPSBhdG9tLmNvbmZpZy5nZXQoJ2dpdC1sb2cuZm9udFNjYWxlJyk7XG4gICAgdGhpcy5mb250X2ZhbWlseSA9IGF0b20uY29uZmlnLmdldCgnZ2l0LWxvZy5mb250RmFtaWx5Jyk7XG4gICAgdGhpcy5yZXBvID0gcmVwbztcbiAgICB0aGlzLmluZm9fcGFuZWwuaGlkZSgpO1xuICAgIHRoaXMucGF0aCA9IHJlcG8ucmVwb19uYW1lO1xuXG4gICAgdGhpcy5mb250X3NpemUgPSBlZGl0b3JGb250U2l6ZSAqIGZvbnRTY2FsZTtcbiAgICB0aGlzLmxpbmVfaGVpZ2h0ID0gTWF0aC5yb3VuZCh0aGlzLmZvbnRfc2l6ZSAqIGVkaXRvckxpbmVIZWlnaHQpO1xuXG4gICAgdGhpcy5nZXRfbG9nKCk7XG5cbiAgICAvL3RoaXMucmVzaXplX3N0YXJ0ZWQgPSBfX2JpbmQodGhpcy5yZXNpemVfc3RhcnRlZCwgdGhpcyk7XG4gICAgLy90aGlzLnJlc2l6ZV90YWJsZSA9IF9fYmluZCh0aGlzLnJlc2l6ZV90YWJsZSwgdGhpcyk7XG4gICAgLy90aGlzLnJlc2l6ZV9zdG9wcGVkID0gX19iaW5kKHRoaXMucmVzaXplX3N0b3BwZWQsIHRoaXMpO1xuICAgIHRoaXMuaGlkZSA9IF9fYmluZCh0aGlzLmluZm9fcGFuZWwuaGlkZSwgdGhpcyk7XG59XG5cbkdpdExvZ1ZpZXcucHJvdG90eXBlLmdldF9sb2cgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLmxvZyA9IG51bGw7XG4gICAgdmFyIGNvbmNhdCA9IGZ1bmN0aW9uKHNlbGYpIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgICAgIGlmKHNlbGYubG9nID09IG51bGwpIHtcbiAgICAgICAgICAgICAgICBzZWxmLmxvZyA9IFwiXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzZWxmLmxvZyArPSBkYXRhO1xuICAgICAgICB9XG4gICAgfSh0aGlzKTtcblxuICAgIHZhciBkaXNwbGF5X2xvZyA9IGZ1bmN0aW9uKHNlbGYpIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgICAgIHNlbGYubG9nX2NhbGxiYWNrKCk7XG4gICAgICAgIH1cbiAgICB9KHRoaXMpO1xuXG4gICAgdmFyIGFyZ3MgPSBbJ2xvZycsICctLWRlY29yYXRlPWZ1bGwnLCAnLS1kYXRlPWRlZmF1bHQnLCAnLS1wcmV0dHk9ZnVsbGVyJywgJy0tYWxsJywgJy0tcGFyZW50cycsICctLW51bXN0YXQnLCAnLS10b3BvLW9yZGVyJywgJy0tcmF3J107XG4gICAgdmFyIG9wdGlvbnMgPSB7fTtcbiAgICBvcHRpb25zLmN3ZCA9IHRoaXMucmVwby5nZXRXb3JraW5nRGlyZWN0b3J5KCk7XG5cbiAgICByZXR1cm4gbmV3IEJ1ZmZlcmVkUHJvY2Vzcyh7XG4gICAgICAgIGNvbW1hbmQ6ICdnaXQnLFxuICAgICAgICBhcmdzOiBhcmdzLFxuICAgICAgICBvcHRpb25zOiBvcHRpb25zLFxuICAgICAgICBzdGRvdXQ6IGNvbmNhdCxcbiAgICAgICAgc3RkZXJyOiBmdW5jdGlvbihkYXRhKSB7Y29uc29sZS5sb2coZGF0YS50b1N0cmluZygpKX0sXG4gICAgICAgIGV4aXQ6IGRpc3BsYXlfbG9nXG4gICAgfSk7XG59O1xuXG5HaXRMb2dWaWV3LnByb3RvdHlwZS5sb2dfY2FsbGJhY2sgPSBmdW5jdGlvbihkYXRhKSB7XG4gICAgdGhpcy5wYXJzZXIoKTtcblxuICAgIC8vdGhpcy5taW5fd2lkdGggPSBNYXRoLmZsb29yKHRoaXMud2lkdGgoKS8xMCk7XG5cbiAgICB0aGlzLmZpbGxfY29udGVudCgpO1xuICAgIC8qKlxuICAgIHRoaXMub24oJ21vdXNlZG93bicsICcucmVzaXplLWhhbmRsZScsIChmdW5jdGlvbihzZWxmKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICBzZWxmLnJlc2l6ZV9zdGFydGVkKGUpO1xuICAgICAgICB9O1xuICAgIH0pKHRoaXMpKTtcbioqL1xuICAgIGF0b20uY29tbWFuZHMuYWRkKCcuZ2l0LWxvZycsICdjb3JlOmNhbmNlbCcsIChmdW5jdGlvbihzZWxmKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICBzZWxmLmluZm9fcGFuZWwuaGlkZSgpO1xuICAgICAgICB9O1xuICAgIH0pKHRoaXMpKTtcblxuICAgIGF0b20uY29tbWFuZHMuYWRkKCcuZ2l0LWxvZycsICdjb3JlOmNsb3NlJywgKGZ1bmN0aW9uKHNlbGYpIHtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIHNlbGYuaW5mb19wYW5lbC5oaWRlKCk7XG4gICAgICAgIH07XG4gICAgfSkodGhpcykpO1xuXG4gICAgYXRvbS5jb21tYW5kcy5hZGQoJy5naXQtbG9nJywgJ2NvcmU6bW92ZS11cCcsIChmdW5jdGlvbihzZWxmKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICBpZigoc2VsZi5wcmV2aW91c19saW5lID09IG51bGwpIHx8IChzZWxmLnByZXZpb3VzX2xpbmUgPT0gMSkpXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgICAgICB2YXIgZGF0YSA9IHNlbGYuZ2V0X3RhcmdldF9saW5lKG51bGwsIHNlbGYucHJldmlvdXNfbGluZSAtIDEpO1xuICAgICAgICAgICAgc2VsZi5oYW5kbGVfc2Nyb2xsKGRhdGFbMF0sIDEpO1xuICAgICAgICAgICAgc2VsZi5zZWxlY3RfZGlzcGxheV9pbmZvKGRhdGFbMF0sIGRhdGFbMV0pO1xuICAgICAgICB9O1xuICAgIH0pKHRoaXMpKTtcblxuICAgIGF0b20uY29tbWFuZHMuYWRkKCcuZ2l0LWxvZycsICdjb3JlOm1vdmUtZG93bicsIChmdW5jdGlvbihzZWxmKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICBpZigoc2VsZi5wcmV2aW91c19saW5lID09IG51bGwpIHx8IChzZWxmLnByZXZpb3VzX2xpbmUgPT0gc2VsZi5sb2cubGVuZ3RoKSlcbiAgICAgICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgICAgIHZhciBkYXRhID0gc2VsZi5nZXRfdGFyZ2V0X2xpbmUobnVsbCwgc2VsZi5wcmV2aW91c19saW5lICsgMSk7XG4gICAgICAgICAgICBzZWxmLmhhbmRsZV9zY3JvbGwoZGF0YVswXSwgMCk7XG4gICAgICAgICAgICBzZWxmLnNlbGVjdF9kaXNwbGF5X2luZm8oZGF0YVswXSwgZGF0YVsxXSk7XG4gICAgICAgIH07XG4gICAgfSkodGhpcykpO1xufTtcblxuR2l0TG9nVmlldy5wcm90b3R5cGUucGFyc2VyID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5sb2cgPSBMb2dQYXJzZXIodGhpcy5sb2cpO1xuICAgIHZhciBncmFwaCA9IG5ldyBHaXRHcmFwaCh0aGlzLm1haW5fcGFuZWwuZ3JhcGgsIHRoaXMubG9nLCB0aGlzLmxpbmVfaGVpZ2h0LCAyKTtcbn07XG5cbkdpdExvZ1ZpZXcucHJvdG90eXBlLmZpbGxfY29udGVudCA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciBjcmVhdGVfbWFpbl9yb3cgPSBmdW5jdGlvbihsb2cpIHtcbiAgICAgICAgdmFyIGh0bWwgPSAnPHRyPjx0ZD48cD4gJm5ic3A7PC9wPjwvdGQ+JztcbiAgICAgICAgaHRtbCArPSAnPHRkPjxwPicgKyBsb2cubWVzc2FnZS5zcGxpdCgnXFxuJylbMF0gKyAnPC9wPjwvdGQ+JztcbiAgICAgICAgaHRtbCArPSAnPHRkPjxwPicgKyBsb2cuc2hhMS5zbGljZSgwLCA3KSsgJzwvcD48L3RkPic7XG5cbiAgICAgICAgdmFyIGRhdGUgPSBsb2cuYXV0aG9yX2RhdGUuc3BsaXQoLyAvKTtcblxuICAgICAgICBodG1sICs9ICc8dGQ+PHA+JyArIGRhdGVbMl0gKyAnICcgKyBkYXRlWzFdICsgJyAnICsgZGF0ZVs0XSArICcgJyArIGRhdGVbM10uc2xpY2UoMCw1KSArICc8L3A+PC90ZD4nXG4gICAgICAgIGh0bWwgKz0gJzx0ZD48cD4nICsgbG9nLmF1dGhvcl9uYW1lICsgICc8L3A+PC90ZD4nXG4gICAgICAgIGh0bWwgKz0gJzwvdHI+J1xuXG4gICAgICAgIHJldHVybiBodG1sO1xuICAgIH07XG5cbiAgICB2YXIgc2V0X3dpZHRocyA9IGZ1bmN0aW9uKHN2Z193aWR0aCkge1xuICAgICAgICB2YXIgdG90YWwgPSBtYWluX3BhbmVsLndpZHRoKCk7XG4gICAgICAgIHZhciBkaWZmID0gdG90YWwgLSBzdmdfd2lkdGg7XG5cbiAgICAgICAgLy8gYWxsb2NhdGUgd2lkdGhzIGluIHRoaXMgcmF0aW8gNzA6MTA6MTA6MTBcbiAgICAgICAgbWFpbl9wYW5lbC5jb21tZW50cy53aWR0aChkaWZmICogLjcpO1xuICAgICAgICBkaWZmID0gZGlmZiAqIDAuMTtcbiAgICAgICAgbWFpbl9wYW5lbC5jb21taXQud2lkdGgoZGlmZik7XG4gICAgICAgIG1haW5fcGFuZWwuZGF0ZS53aWR0aChkaWZmKTtcbiAgICAgICAgbWFpbl9wYW5lbC5hdXRob3Iud2lkdGgoZGlmZik7XG4gICAgfVxuXG4gICAgdmFyIGksIGxlbjtcbiAgICB2YXIgbWFpbl9wYW5lbCA9IHRoaXMubWFpbl9wYW5lbDtcbiAgICBmb3IoaT0wOyBsZW4gPSB0aGlzLmxvZy5sZW5ndGgsIGkgPCBsZW47IGkrKykge1xuICAgICAgICB2YXIgbG9nID0gdGhpcy5sb2dbaV07XG4gICAgICAgIG1haW5fcGFuZWwuYm9keS5hcHBlbmQoY3JlYXRlX21haW5fcm93KGxvZykpO1xuICAgIH1cblxuICAgIHRoaXMuY3NzKHtcbiAgICAgICAgJ2ZvbnQtZmFtaWx5JzogdGhpcy5mb250X2ZhbWlseSxcbiAgICAgICAgJ2ZvbnQtc2l6ZSc6IHRoaXMuZm9udF9zaXplICsgJ3B4JyxcbiAgICAgICAgJ2xpbmUtaGVpZ2h0JzogdGhpcy5saW5lX2hlaWdodCArICdweCdcbiAgICB9KTtcblxuICAgIG1haW5fcGFuZWwuZ3JhcGguY3NzKCd0b3AnLCBtYWluX3BhbmVsLmZpbmQoJ3RoZWFkJykuaGVpZ2h0KCkpO1xuXG4gICAgdmFyIHN2Z193aWR0aCA9IG1haW5fcGFuZWwuZ3JhcGgud2lkdGgoKTtcbiAgICBtYWluX3BhbmVsLmZpbmQoJ3RoZWFkIHRoOmZpcnN0LWNoaWxkJykud2lkdGgoc3ZnX3dpZHRoKTtcbiAgICBzZXRfd2lkdGhzKHN2Z193aWR0aCk7XG5cbiAgICBtYWluX3BhbmVsLmJvZHkub24oXCJjbGlja1wiLCBcInRyXCIsIChmdW5jdGlvbihzZWxmKSB7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICB2YXIgZGF0YSA9IHNlbGYuZ2V0X3RhcmdldF9saW5lKGUpO1xuICAgICAgICAgICAgc2VsZi5zZWxlY3RfZGlzcGxheV9pbmZvKGRhdGFbMF0sIGRhdGFbMV0pO1xuICAgICAgICB9O1xuICAgIH0pKHRoaXMpKTtcbn1cblxuR2l0TG9nVmlldy5wcm90b3R5cGUuZ2V0VGl0bGUgPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gXCJHaXQtbG9nOiBcIiArIHRoaXMucGF0aDtcbn07XG5cbkdpdExvZ1ZpZXcucHJvdG90eXBlLmdldFVSSSA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBcImdpdC1sb2c6Ly9cIiArIHRoaXMucGF0aDtcbn07XG5cbkdpdExvZ1ZpZXcucHJvdG90eXBlLm9uRGlkQ2hhbmdlVGl0bGUgPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm47XG59O1xuXG5HaXRMb2dWaWV3LnByb3RvdHlwZS5vbkRpZENoYW5nZU1vZGlmaWVkID0gZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuO1xufTtcblxuR2l0TG9nVmlldy5wcm90b3R5cGUuZ2V0X2ltYWdlID0gZnVuY3Rpb24oZW1haWwpIHtcbiAgICB2YXIgY3J5cHRvID0gcmVxdWlyZSgnY3J5cHRvJyk7XG4gICAgdmFyIGJhc2UgPSBcImh0dHA6Ly93d3cuZ3JhdmF0YXIuY29tL2F2YXRhci9cIjtcbiAgICByZXR1cm4gYmFzZSArIGNyeXB0by5jcmVhdGVIYXNoKCdtZDUnKS51cGRhdGUoZW1haWwudG9Mb3dlckNhc2UoKS50cmltKCkpLmRpZ2VzdCgnaGV4JykgKyBcIj9zPTY0XCI7XG59O1xuXG5HaXRMb2dWaWV3LnByb3RvdHlwZS5yZXNpemVfc3RhcnRlZCA9IGZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgdGhpcy5wb3M9e307XG4gICAgdGhpcy5wb3MucG9pbnRlcl94ID0gZXZlbnQucGFnZVg7XG4gICAgdGhpcy5wb3MubGVmdCA9ICQoZXZlbnQudGFyZ2V0KS5wb3NpdGlvbigpLmxlZnQ7XG5cbiAgICB0aGlzLnBvcy5sZWZ0X2NvbCA9ICQoZXZlbnQudGFyZ2V0KS5wYXJlbnRzKCcuY29sdW1uJyk7XG4gICAgdGhpcy5wb3MucmlnaHRfY29sID0gJCh0aGlzLnBvcy5sZWZ0X2NvbC5uZXh0KCkpO1xuXG4gICAgdGhpcy5wb3MubGVmdF93aWR0aCA9IHRoaXMucG9zLmxlZnRfY29sLndpZHRoKCk7XG4gICAgdGhpcy5wb3MucmlnaHRfd2lkdGggPSB0aGlzLnBvcy5yaWdodF9jb2wud2lkdGgoKTtcblxuICAgICQoZG9jdW1lbnQpLm9uKCdtb3VzZW1vdmUuZ2l0LWxvZycsIHRoaXMucmVzaXplX3RhYmxlKTtcbiAgICAkKGRvY3VtZW50KS5vbignbW91c2V1cC5naXQtbG9nJywgdGhpcy5yZXNpemVfc3RvcHBlZCk7XG4gICAgcmV0dXJuIGZhbHNlO1xufTtcblxuR2l0TG9nVmlldy5wcm90b3R5cGUucmVzaXplX3RhYmxlID0gZnVuY3Rpb24oZXZlbnQpIHtcbiAgICBpZighdGhpcy5wb3MpXG4gICAgICAgIHJldHVybjtcblxuICAgIHZhciB4ID0gZXZlbnQucGFnZVggLSB0aGlzLnBvcy5wb2ludGVyX3ggKyB0aGlzLnBvcy5sZWZ0O1xuICAgIHRoaXMucG9zLnggPSB4O1xuXG4gICAgdmFyIGluYyA9IHRoaXMucG9zLnggLSB0aGlzLnBvcy5sZWZ0O1xuXG4gICAgdmFyIHcgPSB0aGlzLnBvcy5sZWZ0X3dpZHRoICsgaW5jO1xuICAgIHZhciB3MiA9IHRoaXMucG9zLnJpZ2h0X3dpZHRoIC0gaW5jO1xuXG4gICAgdyA9IE1hdGgubWF4KHRoaXMubWluX3dpZHRoLCB3KTtcbiAgICB3MiA9IE1hdGgubWF4KHRoaXMubWluX3dpZHRoLCB3Mik7XG5cbiAgICAvL3RoaXMucG9zLmxlZnRfY29sLndpZHRoKHcgKyAncHgnKTtcbiAgICAvL3RoaXMucG9zLnJpZ2h0X2NvbC53aWR0aCh3MiArICdweCcpO1xuXG4gICAgdGhpcy5wb3MubGVmdF9jb2wuY3NzKCdmbGV4LWJhc2lzJywgdyArICdweCcpO1xuICAgIHRoaXMucG9zLnJpZ2h0X2NvbC5jc3MoJ2ZsZXgtYmFzaXMnLCB3MiArICdweCcpO1xuICAgIHJldHVybiBmYWxzZTtcbn1cblxuR2l0TG9nVmlldy5wcm90b3R5cGUucmVzaXplX3N0b3BwZWQgPSBmdW5jdGlvbihldmVudCkge1xuICAgIHRoaXMucG9zID0gbnVsbDtcbiAgICAkKGRvY3VtZW50KS5vZmYoJ21vdXNlbW92ZS5naXQtbG9nJywgdGhpcy5yZXNpemVfdGFibGUpO1xuICAgICQoZG9jdW1lbnQpLm9mZignbW91c2V1cC5naXQtbG9nJywgdGhpcy5yZXNpemVfc3RvcHBlZCk7XG59XG5cbkdpdExvZ1ZpZXcucHJvdG90eXBlLmdldF90YXJnZXRfbGluZSA9IGZ1bmN0aW9uKGV2ZW50LCBsaW5lKSB7XG4gICAgdmFyIGxpbmVfbm8sIHRhcmdldDtcbiAgICBpZihldmVudCA9PSBudWxsKSB7XG4gICAgICAgIGxpbmVfbm8gPSBsaW5lO1xuICAgICAgICB0YXJnZXQgPSB0aGlzLm1haW5fcGFuZWwuYm9keS5maW5kKCd0cjpudGgtY2hpbGQoJyArIGxpbmVfbm8gKyAnKScpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgbGluZV9ubyA9ICQoZXZlbnQuY3VycmVudFRhcmdldCkuaW5kZXgoKSArIDE7XG4gICAgICAgIHRhcmdldCA9ICQoZXZlbnQuY3VycmVudFRhcmdldCk7XG4gICAgfVxuICAgIHJldHVybiBbdGFyZ2V0LCBsaW5lX25vXTtcbn07XG5cbkdpdExvZ1ZpZXcucHJvdG90eXBlLmhhbmRsZV9zY3JvbGwgPSBmdW5jdGlvbih0YXJnZXQsIGRpcikge1xuICAgIHZhciBvZmZzZXRfdHJpZ2dlciA9IDM7XG4gICAgdmFyIGxpbmVfaGVpZ2h0ID0gJCh0YXJnZXQpLmhlaWdodCgpICsgMjsgLy8gYWNjb3VudGluZyBmb3IgdGhlIG1hcmdpblxuICAgIG9mZnNldF90cmlnZ2VyID0gb2Zmc2V0X3RyaWdnZXIgKiBsaW5lX2hlaWdodDtcbiAgICB2YXIgd2luZG93X2hlaWdodCA9IHRoaXMubWFpbl9wYW5lbC5oZWlnaHQoKTtcbiAgICAvLyBtb3ZlIHVwXG4gICAgaWYoZGlyID09IDEpIHtcbiAgICAgICAgaWYodGFyZ2V0Lm9mZnNldCgpLnRvcCA8IG9mZnNldF90cmlnZ2VyKSB7XG4gICAgICAgICAgICB0aGlzLm1haW5fcGFuZWwuc2Nyb2xsVG9wKHRoaXMubWFpbl9wYW5lbC5zY3JvbGxUb3AoKSAtIGxpbmVfaGVpZ2h0KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGVsc2UgaWYoZGlyID09IDApIHtcbiAgICAgICAgaWYodGFyZ2V0Lm9mZnNldCgpLnRvcCA+ICh3aW5kb3dfaGVpZ2h0IC0gb2Zmc2V0X3RyaWdnZXIpKSB7XG4gICAgICAgICAgICB0aGlzLm1haW5fcGFuZWwuc2Nyb2xsVG9wKHRoaXMubWFpbl9wYW5lbC5zY3JvbGxUb3AoKSArIGxpbmVfaGVpZ2h0KTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5cbkdpdExvZ1ZpZXcucHJvdG90eXBlLnNlbGVjdF9kaXNwbGF5X2luZm8gPSBmdW5jdGlvbih0YXJnZXQsIGxpbmVfbm8pIHtcbiAgICBpZighdGhpcy5pbmZvX3BhbmVsLmlzVmlzaWJsZSgpKVxuICAgICAgICB0aGlzLmluZm9fcGFuZWwuc2hvdygpO1xuXG4gICAgdGhpcy5pbmZvX3BhbmVsLmluZm9fZGF0YS5lbXB0eSgpO1xuICAgIHRoaXMuaW5mb19wYW5lbC5pbmZvX2ltYWdlLmVtcHR5KCk7XG4gICAgdGhpcy5pbmZvX3BhbmVsLmJvZHkuZW1wdHkoKTtcblxuICAgIHZhciBjb21taXRfZGF0YSA9IHRoaXMubG9nW2xpbmVfbm8gLSAxXTtcblxuICAgIC8vIGJhY2tncm91bmQgbGluZSBoaWdsaWdodGluZ1xuICAgIGlmKHRoaXMucHJldmlvdXNfbGluZSAhPSBudWxsKVxuICAgICAgICB0aGlzLm1haW5fcGFuZWwuYm9keS5maW5kKCd0cjpudGgtY2hpbGQoJyArIHRoaXMucHJldmlvdXNfbGluZSArICcpJylcbiAgICAgICAgICAgIC5yZW1vdmVDbGFzcygnbG9nLWhpZ2hsaWdodCcpO1xuXG4gICAgdGhpcy5wcmV2aW91c19saW5lID0gbGluZV9ubztcbiAgICB0YXJnZXQuYWRkQ2xhc3MoJ2xvZy1oaWdobGlnaHQnKTtcblxuICAgIHRoaXMuaW5mb19wYW5lbC5hZGRfY29udGVudChcIkNvbW1pdDpcIiwgY29tbWl0X2RhdGEuc2hhMSArIFwiIFtcIiArIGNvbW1pdF9kYXRhLnNoYTEuc2xpY2UoMCw3KSArXCJdXCIgKTtcbiAgICB0aGlzLmluZm9fcGFuZWwuYWRkX2NvbnRlbnQoXCJQYXJlbnRzOlwiLCBjb21taXRfZGF0YS5wYXJlbnRzLm1hcChmdW5jdGlvbihzdHIpIHtcbiAgICAgICAgICAgIHJldHVybiBzdHIuc2xpY2UoMCwxMCk7XG4gICAgICAgIH0pLmpvaW4oXCIsIFwiKVxuICAgICk7XG4gICAgdGhpcy5pbmZvX3BhbmVsLmFkZF9jb250ZW50KFwiQXV0aG9yOlwiLCBjb21taXRfZGF0YS5hdXRob3JfbmFtZSArICcgPCcgKyBjb21taXRfZGF0YS5hdXRob3JfZW1haWwgKyAnPicpO1xuICAgIHZhciBkYXRlID0gY29tbWl0X2RhdGEuYXV0aG9yX2RhdGUuc3BsaXQoLyAvKTtcbiAgICB0aGlzLmluZm9fcGFuZWwuYWRkX2NvbnRlbnQoXCJEYXRlOlwiLCBkYXRlWzJdICsgJyAnICsgZGF0ZVsxXSArICcgJyArIGRhdGVbNF0gKyAnICcgKyBkYXRlWzNdLnNsaWNlKDAsOCkpXG5cbiAgICAvLyBhZGQgY29tbWl0dGVyIHJlbGF0ZWQgaW5mb3JtYXRpb25cbiAgICBpZihjb21taXRfZGF0YS5jb21taXR0ZXJfbmFtZSAhPSBjb21taXRfZGF0YS5hdXRob3JfbmFtZSkge1xuICAgICAgICB0aGlzLmluZm9fcGFuZWwuYWRkX2NvbnRlbnQoXCJDb21taXR0ZXI6XCIsIGNvbW1pdF9kYXRhLmNvbW1pdHRlcl9uYW1lICsgJyA8JyArIGNvbW1pdF9kYXRhLmNvbW1pdHRlcl9lbWFpbCArICc+Jyk7XG4gICAgICAgIGRhdGUgPSBjb21taXRfZGF0YS5jb21taXRfZGF0ZS5zcGxpdCgvIC8pO1xuICAgICAgICB0aGlzLmluZm9fcGFuZWwuYWRkX2NvbnRlbnQoXCJDb21taXQgRGF0ZTpcIiwgZGF0ZVsyXSArICcgJyArIGRhdGVbMV0gKyAnICcgKyBkYXRlWzRdICsgJyAnICsgZGF0ZVszXS5zbGljZSgwLDgpKVxuICAgIH1cblxuICAgIC8vIHJlbW92ZSByZWZzL2hlYWRzIG9yIHJlZnMvcmVtb3Rlc1xuICAgIGlmKGNvbW1pdF9kYXRhLnJlZnMubGVuZ3RoID4gMClcbiAgICAgICAgdGhpcy5pbmZvX3BhbmVsLmFkZF9jb250ZW50KFwiTGFiZWxzOlwiLCBjb21taXRfZGF0YS5yZWZzLm1hcChmdW5jdGlvbihzdHIpIHtcbiAgICAgICAgICAgIHJldHVybiBzdHIucmVwbGFjZSgvXi4qXFwvKHJlbW90ZXN8aGVhZHMpXFwvLywnJyk7XG4gICAgICAgIH0pLmpvaW4oXCIsIFwiKSk7XG4gICAgdGhpcy5pbmZvX3BhbmVsLmluZm9fZGF0YS5hcHBlbmQoJzxwPicgKyBzYWZlX3RhZ3MoY29tbWl0X2RhdGEubWVzc2FnZSkucmVwbGFjZSgvXFxuL2csICc8YnI+JykgKyBcIjwvcD5cIik7XG4gICAgdGhpcy5pbmZvX3BhbmVsLmluZm9faW1hZ2UuYXBwZW5kKCc8aW1nIHNyYz1cIicgKyBzYWZlX3RhZ3ModGhpcy5nZXRfaW1hZ2UoY29tbWl0X2RhdGEuYXV0aG9yX2VtYWlsKSkgKyAnXCIvPicpXG5cbiAgICBpZihjb21taXRfZGF0YS5jb21taXR0ZXJfbmFtZSAhPSBjb21taXRfZGF0YS5hdXRob3JfbmFtZSkge1xuICAgICAgICB0aGlzLmluZm9fcGFuZWwuaW5mb19pbWFnZS5hcHBlbmQoJzxpbWcgc3JjPVwiJyArIHNhZmVfdGFncyh0aGlzLmdldF9pbWFnZShjb21taXRfZGF0YS5jb21taXR0ZXJfZW1haWwpKSArICdcIi8+JylcbiAgICB9XG5cbiAgICAvLyBmaWxsIHRoZSBmaWxlIGluZm9ybWF0aW9uXG4gICAgdmFyIGksIGxlbiwgdGVtcCwgc3RhdHVzX3RleHQ7XG5cbiAgICB2YXIgY3JlYXRlX3JvdyA9IGZ1bmN0aW9uKHRlbXApIHtcbiAgICAgICAgdmFyIHRlbXAsIHN0YXR1c190ZXh0LCBpbmRleDtcbiAgICAgICAgdmFyIGh0bWwgPSAnPHRyPic7XG5cbiAgICAgICAgaWYodGVtcFszXSA9PSAnQScpXG4gICAgICAgICAgICBzdGF0dXNfdGV4dCA9ICdhZGRlZCc7XG4gICAgICAgIGVsc2UgaWYodGVtcFszXSA9PSAnRCcpXG4gICAgICAgICAgICBzdGF0dXNfdGV4dCA9ICdkZWxldGVkJztcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgc3RhdHVzX3RleHQgPSAnbW9kaWZpZWQnO1xuICAgICAgICBodG1sICs9ICc8dGQ+PHA+JyArIHN0YXR1c190ZXh0ICsgJzwvcD48L3RkPic7XG5cbiAgICAgICAgaW5kZXggPSB0ZW1wWzJdLmxhc3RJbmRleE9mKCcvJyk7XG4gICAgICAgIGh0bWwgKz0gJzx0ZD48cD4nICsgdGVtcFsyXS5zbGljZShpbmRleCArIDEpICsgJzwvcD48L3RkPic7XG4gICAgICAgIGh0bWwgKz0gJzx0ZD48cD4nICsgKChpbmRleCA+PSAwKSA/IHRlbXBbMl0uc2xpY2UoMCwgaW5kZXgpIDogJyZuYnNwOycpICsgJzwvcD48L3RkPidcbiAgICAgICAgaHRtbCArPSAnPHRkPjxwPicgKyB0ZW1wWzBdICsgICc8L3A+PC90ZD4nO1xuICAgICAgICBodG1sICs9ICc8dGQ+PHA+JyArIHRlbXBbMV0gKyAgJzwvcD48L3RkPic7XG4gICAgICAgIGh0bWwgKz0gJzwvdHI+JztcblxuICAgICAgICByZXR1cm4gaHRtbDtcbiAgICB9O1xuXG4gICAgdGhpcy5pbmZvX3BhbmVsLmluZm9fZmlsZS5zaG93KCk7XG4gICAgaWYoY29tbWl0X2RhdGEuZmlsZV9saW5lX2RpZmZzLmxlbmd0aCA9PSAwKVxuICAgICAgICB0aGlzLmluZm9fcGFuZWwuaW5mb19maWxlLmhpZGUoKTtcblxuICAgIHZhciBpLCBsZW4sIHRlbXA7XG4gICAgZm9yKGk9MTsgbGVuPWNvbW1pdF9kYXRhLmZpbGVfbGluZV9kaWZmcy5sZW5ndGgsIGk8bGVuO2krKykge1xuICAgICAgICB0ZW1wID0gY3JlYXRlX3Jvdyhjb21taXRfZGF0YS5maWxlX2xpbmVfZGlmZnNbaV0pO1xuICAgICAgICB0aGlzLmluZm9fcGFuZWwuYm9keS5hcHBlbmQodGVtcCk7XG4gICAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSBHaXRMb2dWaWV3O1xuIl19