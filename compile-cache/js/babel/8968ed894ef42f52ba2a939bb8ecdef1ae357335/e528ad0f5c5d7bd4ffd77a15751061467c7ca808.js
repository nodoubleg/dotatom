//var d3 = require('d3');

var is_empty = function is_empty(obj) {
    if (obj == null) return true;
    if (obj.length > 0) return false;
    if (obj.length === 0) return true;
    for (var key in obj) {
        if (hasOwnProperty.call(obj, key)) return false;
    }
    return true;
};

function GitGraph(location, data, line_height, margin) {
    this.config = this.set_config(line_height, margin);
    this.set_position(data);
    var svg = this.render(location, data);
}

GitGraph.prototype.set_config = function (line_height, margin) {
    var config = {};
    var circle_radius_percent = 20;
    var circle_stroke_percent = 8;
    var branch_spacing_percent = 60;
    var line_width_percent = 10;

    var percentage = function percentage(percent) {
        return line_height * percent / 100;
    };

    config.circle = {};
    config.circle.radius = percentage(circle_radius_percent);
    config.circle.stroke = percentage(circle_stroke_percent);
    config.circle_spacing = line_height + margin;
    config.branch_spacing = percentage(branch_spacing_percent);
    config.line_width = percentage(line_width_percent);
    config.left_margin = line_height / 2;
    config.top_margin = line_height / 2;
    config.cross_height = 40 / 100;
    /*config.color_list = [
        "#1f77b4", "#aec7e8", "#ff7f0e", "#ffbb78", "#2ca02c", "#98df8a", "#d62728", "#ff9896",
        "#9467bd", "#c5b0d5", "#8c564b", "#c49c94", "#e377c2", "#f7b6d2", "#7f7f7f", "#c7c7c7",
        "#bcbd22", "#dbdb8d","#17becf", "#9edae5"
    ];
    config.color_list = [
        "#393b79", "#5254a3", "#6b6ecf", "#9c9ede", "#637939", "#8ca252", "#b5cf6b", "#cedb9c",
        "#8c6d31", "#bd9e39", "#e7ba52", "#e7cb94", "#843c39", "#ad494a", "#d6616b", "#e7969c",
        "#7b4173", "#a55194", "#ce6dbd", "#de9ed6"
    ];
    config.color_list = [
        "#3182bd", "#6baed6", "#9ecae1", "#c6dbef", "#e6550d", "#fd8d3c", "#fdae6b", "#fdd0a2",
        "#31a354", "#74c476", "#a1d99b", "#c7e9c0", "#756bb1", "#9e9ac8", "#bcbddc", "#dadaeb",
        "#636363", "#969696", "#bdbdbd", "#d9d9d9"
    ];*/
    config.color_list = ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"];
    return config;
};

GitGraph.prototype.set_position = function (data) {
    var _i, _len;
    var curr_row, curr_col;
    var branches = [];
    this.max_level = 0;

    curr_row = curr_col = 0;

    var get_free_column = function get_free_column() {
        var i, len;
        for (i = 0; len = branches.length, i < len; i++) {
            if (branches[i] == null) return i;
        }
        return len;
    };

    var update_branch = function update_branch(parent, col) {
        branches[col] = parent;
    };

    var create_branch = function create_branch(commit) {
        var i, len, index, my_col, par_col;
        var par, sha1;

        if ((index = branches.indexOf(commit.sha1)) > -1) {
            my_col = index;
        } else {
            my_col = get_free_column();
        }
        while ((index = branches.indexOf(commit.sha1)) > -1) {
            branches[index] = null;
        }

        for (i = 0; len = commit.parents.length, i < len; i++) {
            par = commit.parents[i];

            if ((index = branches.indexOf(par)) > -1) {
                if (branches[my_col] == null) update_branch(par, my_col);
            } else {
                if (len == 1 || i == 0) {
                    // dont create new branch
                    update_branch(par, my_col);
                } else {
                    par_col = get_free_column();
                    update_branch(par, par_col);
                }
            }
        }
        return my_col;
    };

    for (_i = 0; _len = data.length, _i < _len; _i++) {
        var commit = data[_i];
        var position = {};

        position.column = create_branch(commit);
        if (position.column > this.max_level) this.max_column = position.column;
        position.row = curr_row++;
        commit.position = position;
    }
    this.max_row = curr_row;
};

GitGraph.prototype.commit_search = function (data, commit) {
    var i, len;
    for (i = 0; len = data.length, i < len; i++) {
        if (data[i].sha1 === commit) return i;
    }
};

GitGraph.prototype.lines = function (data) {
    var create_mid_point = function create_mid_point(start, end, height) {
        var point = {};
        if (start.x == end.x) {
            return false;
        } else if (start.x < end.x) {
            point.x = end.x;
            point.y = start.y + height;
        } else {
            point.x = start.x;
            point.y = end.y - height;
        }
        return point;
    };

    var i, len;
    var height = this.config.cross_height;
    var colors = this.config.color_list;
    var line_array = [];
    var line_color = [];
    for (i = 0; len = data.length, i < len; i++) {
        var commit, j, _len;
        commit = data[i];
        // assign color for commit
        if (line_color[commit.position.column] == null) {
            clr = colors.shift();
            colors.push(clr);
            line_color[commit.position.column] = clr;
        } else {
            clr = line_color[commit.position.column];
        }
        commit.position.color = clr;

        for (j = 0; _len = commit.parents.length, j < _len; j++) {
            var line = [];
            var start, mid, end, clr;
            start = {};mid = {};end = {};

            var index = this.commit_search(data, commit.parents[j]);
            var parent = data[index];

            start.x = commit.position.column;
            start.y = commit.position.row;
            end.x = parent.position.column;
            end.y = parent.position.row;

            if (start.x < end.x) {

                mid.x = end.x;
                mid.y = start.y + height;
                clr = colors.shift();
                colors.push(clr);

                line_color[end.x] = clr;
            } else if (start.x > end.x) {
                mid.x = start.x;
                mid.y = end.y - height;
                line_color[start.x] = null;
            }
            start.color = clr;
            line.push(start);
            if (is_empty(mid) == false) line.push(mid);
            line.push(end);
            line_array.push(line);
        }
    }
    return line_array;
};

GitGraph.prototype.render = function (location, data) {
    var line_array = this.lines(data);
    var self = this;

    var create_line = function create_line(d) {
        var x, y, point_no;
        var line;
        point_no = 1;
        for (var i = 0; len = d.length, i < len; i++) {
            x = self.config.left_margin + d[i].x * self.config.branch_spacing;
            y = self.config.top_margin + d[i].y * self.config.circle_spacing;
            if (point_no == 1) {
                line = "M" + x + "," + y;
                point_no++;
            } else {
                line += "L" + x + "," + y;
            }
        }
        return line;
    };

    var create_element = function create_element(type) {
        return document.createElementNS("http://www.w3.org/2000/svg", type);
    };

    var height = this.config.top_margin + this.max_row * this.config.circle_spacing;

    var svg = create_element("svg");

    var line_group = svg.appendChild(create_element("g"));
    var circle_group = svg.appendChild(create_element("g"));

    circle_group.setAttribute("stoke-width", self.config.circle.stroke);
    circle_group.setAttribute("stroke", "#000");

    data.forEach(function (d) {
        var circle = circle_group.appendChild(create_element("circle"));
        circle.setAttribute("cx", self.config.left_margin + d.position.column * self.config.branch_spacing);
        circle.setAttribute("cy", self.config.top_margin + d.position.row * self.config.circle_spacing);
        circle.setAttribute("r", self.config.circle.radius);
        circle.setAttribute("fill", d.position.color);
    });

    line_group.setAttribute("stroke", "#000");
    line_group.setAttribute("stroke-width", this.config.line_width);
    line_group.setAttribute("fill", "none");

    line_array.forEach(function (d) {
        var path = line_group.appendChild(create_element("path"));
        path.setAttribute("d", create_line(d));
        path.setAttribute("stroke", d[0].color);
    });

    location.append(svg);
    svg.setAttribute("width", svg.childNodes[1].getBoundingClientRect().width + this.config.left_margin);
    svg.setAttribute("height", height);
    return svg;
};

module.exports = GitGraph;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9nbWFzb24vLmF0b20vcGFja2FnZXMvZ2l0LWxvZy9saWIvZ2l0Z3JhcGguanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFHQSxJQUFJLFFBQVEsR0FBRyxTQUFYLFFBQVEsQ0FBWSxHQUFHLEVBQUU7QUFDekIsUUFBSSxHQUFHLElBQUksSUFBSSxFQUFFLE9BQU8sSUFBSSxDQUFDO0FBQzdCLFFBQUksR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUssT0FBTyxLQUFLLENBQUM7QUFDcEMsUUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRyxPQUFPLElBQUksQ0FBQztBQUNuQyxTQUFLLElBQUksR0FBRyxJQUFJLEdBQUcsRUFBRTtBQUNqQixZQUFJLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxFQUFFLE9BQU8sS0FBSyxDQUFDO0tBQ25EO0FBQ0QsV0FBTyxJQUFJLENBQUM7Q0FDZixDQUFDOztBQUVGLFNBQVMsUUFBUSxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRTtBQUNuRCxRQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQ25ELFFBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDeEIsUUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7Q0FDekM7O0FBRUQsUUFBUSxDQUFDLFNBQVMsQ0FBQyxVQUFVLEdBQUcsVUFBUyxXQUFXLEVBQUUsTUFBTSxFQUFFO0FBQzFELFFBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQztBQUNoQixRQUFJLHFCQUFxQixHQUFHLEVBQUUsQ0FBQztBQUMvQixRQUFJLHFCQUFxQixHQUFHLENBQUMsQ0FBQztBQUM5QixRQUFJLHNCQUFzQixHQUFHLEVBQUUsQ0FBQztBQUNoQyxRQUFJLGtC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QyxDQUFDO0tBQzNDLENBQUMsQ0FBQTs7QUFFRixZQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3JCLE9BQUcsQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMscUJBQXFCLEVBQUUsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUNyRyxPQUFHLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUNuQyxXQUFPLEdBQUcsQ0FBQztDQUNkLENBQUM7O0FBRUYsTUFBTSxDQUFDLE9BQU8sR0FBRyxRQUFRLENBQUMiLCJmaWxlIjoiL1VzZXJzL2dtYXNvbi8uYXRvbS9wYWNrYWdlcy9naXQtbG9nL2xpYi9naXRncmFwaC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vdmFyIGQzID0gcmVxdWlyZSgnZDMnKTtcblxuXG52YXIgaXNfZW1wdHkgPSBmdW5jdGlvbihvYmopIHtcbiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiB0cnVlO1xuICAgIGlmIChvYmoubGVuZ3RoID4gMCkgICAgcmV0dXJuIGZhbHNlO1xuICAgIGlmIChvYmoubGVuZ3RoID09PSAwKSAgcmV0dXJuIHRydWU7XG4gICAgZm9yICh2YXIga2V5IGluIG9iaikge1xuICAgICAgICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmosIGtleSkpIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG59O1xuXG5mdW5jdGlvbiBHaXRHcmFwaChsb2NhdGlvbiwgZGF0YSwgbGluZV9oZWlnaHQsIG1hcmdpbikge1xuICAgIHRoaXMuY29uZmlnID0gdGhpcy5zZXRfY29uZmlnKGxpbmVfaGVpZ2h0LCBtYXJnaW4pO1xuICAgIHRoaXMuc2V0X3Bvc2l0aW9uKGRhdGEpO1xuICAgIHZhciBzdmcgPSB0aGlzLnJlbmRlcihsb2NhdGlvbiwgZGF0YSk7XG59XG5cbkdpdEdyYXBoLnByb3RvdHlwZS5zZXRfY29uZmlnID0gZnVuY3Rpb24obGluZV9oZWlnaHQsIG1hcmdpbikge1xuICAgIHZhciBjb25maWcgPSB7fTtcbiAgICB2YXIgY2lyY2xlX3JhZGl1c19wZXJjZW50ID0gMjA7XG4gICAgdmFyIGNpcmNsZV9zdHJva2VfcGVyY2VudCA9IDg7XG4gICAgdmFyIGJyYW5jaF9zcGFjaW5nX3BlcmNlbnQgPSA2MDtcbiAgICB2YXIgbGluZV93aWR0aF9wZXJjZW50ID0gMTA7XG5cbiAgICB2YXIgcGVyY2VudGFnZSA9IGZ1bmN0aW9uKHBlcmNlbnQpIHtcbiAgICAgICAgcmV0dXJuIChsaW5lX2hlaWdodCAqIHBlcmNlbnQpLzEwMDtcbiAgICB9XG5cbiAgICBjb25maWcuY2lyY2xlID0ge307XG4gICAgY29uZmlnLmNpcmNsZS5yYWRpdXMgPSBwZXJjZW50YWdlKGNpcmNsZV9yYWRpdXNfcGVyY2VudCk7XG4gICAgY29uZmlnLmNpcmNsZS5zdHJva2UgPSBwZXJjZW50YWdlKGNpcmNsZV9zdHJva2VfcGVyY2VudCk7XG4gICAgY29uZmlnLmNpcmNsZV9zcGFjaW5nID0gbGluZV9oZWlnaHQgKyBtYXJnaW47XG4gICAgY29uZmlnLmJyYW5jaF9zcGFjaW5nID0gcGVyY2VudGFnZShicmFuY2hfc3BhY2luZ19wZXJjZW50KTtcbiAgICBjb25maWcubGluZV93aWR0aCA9IHBlcmNlbnRhZ2UobGluZV93aWR0aF9wZXJjZW50KTtcbiAgICBjb25maWcubGVmdF9tYXJnaW4gPSBsaW5lX2hlaWdodCAvIDI7XG4gICAgY29uZmlnLnRvcF9tYXJnaW4gPSBsaW5lX2hlaWdodCAvIDI7XG4gICAgY29uZmlnLmNyb3NzX2hlaWdodCA9IDQwLzEwMDtcbiAgICAvKmNvbmZpZy5jb2xvcl9saXN0ID0gW1xuICAgICAgICBcIiMxZjc3YjRcIiwgXCIjYWVjN2U4XCIsIFwiI2ZmN2YwZVwiLCBcIiNmZmJiNzhcIiwgXCIjMmNhMDJjXCIsIFwiIzk4ZGY4YVwiLCBcIiNkNjI3MjhcIiwgXCIjZmY5ODk2XCIsXG4gICAgICAgIFwiIzk0NjdiZFwiLCBcIiNjNWIwZDVcIiwgXCIjOGM1NjRiXCIsIFwiI2M0OWM5NFwiLCBcIiNlMzc3YzJcIiwgXCIjZjdiNmQyXCIsIFwiIzdmN2Y3ZlwiLCBcIiNjN2M3YzdcIixcbiAgICAgICAgXCIjYmNiZDIyXCIsIFwiI2RiZGI4ZFwiLFwiIzE3YmVjZlwiLCBcIiM5ZWRhZTVcIlxuICAgIF07XG4gICAgY29uZmlnLmNvbG9yX2xpc3QgPSBbXG4gICAgICAgIFwiIzM5M2I3OVwiLCBcIiM1MjU0YTNcIiwgXCIjNmI2ZWNmXCIsIFwiIzljOWVkZVwiLCBcIiM2Mzc5MzlcIiwgXCIjOGNhMjUyXCIsIFwiI2I1Y2Y2YlwiLCBcIiNjZWRiOWNcIixcbiAgICAgICAgXCIjOGM2ZDMxXCIsIFwiI2JkOWUzOVwiLCBcIiNlN2JhNTJcIiwgXCIjZTdjYjk0XCIsIFwiIzg0M2MzOVwiLCBcIiNhZDQ5NGFcIiwgXCIjZDY2MTZiXCIsIFwiI2U3OTY5Y1wiLFxuICAgICAgICBcIiM3YjQxNzNcIiwgXCIjYTU1MTk0XCIsIFwiI2NlNmRiZFwiLCBcIiNkZTllZDZcIlxuICAgIF07XG4gICAgY29uZmlnLmNvbG9yX2xpc3QgPSBbXG4gICAgICAgIFwiIzMxODJiZFwiLCBcIiM2YmFlZDZcIiwgXCIjOWVjYWUxXCIsIFwiI2M2ZGJlZlwiLCBcIiNlNjU1MGRcIiwgXCIjZmQ4ZDNjXCIsIFwiI2ZkYWU2YlwiLCBcIiNmZGQwYTJcIixcbiAgICAgICAgXCIjMzFhMzU0XCIsIFwiIzc0YzQ3NlwiLCBcIiNhMWQ5OWJcIiwgXCIjYzdlOWMwXCIsIFwiIzc1NmJiMVwiLCBcIiM5ZTlhYzhcIiwgXCIjYmNiZGRjXCIsIFwiI2RhZGFlYlwiLFxuICAgICAgICBcIiM2MzYzNjNcIiwgXCIjOTY5Njk2XCIsIFwiI2JkYmRiZFwiLCBcIiNkOWQ5ZDlcIlxuICAgIF07Ki9cbiAgICBjb25maWcuY29sb3JfbGlzdCA9IFtcbiAgICAgICAgXCIjMWY3N2I0XCIsIFwiI2ZmN2YwZVwiLCBcIiMyY2EwMmNcIiwgXCIjZDYyNzI4XCIsIFwiIzk0NjdiZFwiLCBcIiM4YzU2NGJcIiwgXCIjZTM3N2MyXCIsIFwiIzdmN2Y3ZlwiLFxuICAgICAgICBcIiNiY2JkMjJcIiwgXCIjMTdiZWNmXCJcbiAgICBdO1xuICAgIHJldHVybiBjb25maWc7XG59O1xuXG5HaXRHcmFwaC5wcm90b3R5cGUuc2V0X3Bvc2l0aW9uID0gZnVuY3Rpb24oZGF0YSkge1xuICAgIHZhciBfaSwgX2xlbjtcbiAgICB2YXIgY3Vycl9yb3csIGN1cnJfY29sO1xuICAgIHZhciBicmFuY2hlcyA9IFtdO1xuICAgIHRoaXMubWF4X2xldmVsID0gMDtcblxuICAgIGN1cnJfcm93ID0gY3Vycl9jb2wgPSAwO1xuXG4gICAgdmFyIGdldF9mcmVlX2NvbHVtbiA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgaSwgbGVuO1xuICAgICAgICBmb3IoaT0wOyBsZW4gPSBicmFuY2hlcy5sZW5ndGgsIGkgPCBsZW47IGkrKykge1xuICAgICAgICAgICAgaWYoYnJhbmNoZXNbaV0gPT0gbnVsbClcbiAgICAgICAgICAgICAgICByZXR1cm4gaTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbGVuO1xuICAgIH1cblxuICAgIHZhciB1cGRhdGVfYnJhbmNoID0gZnVuY3Rpb24ocGFyZW50LCBjb2wpIHtcbiAgICAgICAgYnJhbmNoZXNbY29sXSA9IHBhcmVudDtcbiAgICB9XG5cbiAgICB2YXIgY3JlYXRlX2JyYW5jaCA9IGZ1bmN0aW9uKGNvbW1pdCkge1xuICAgICAgICB2YXIgaSwgbGVuLCBpbmRleCwgbXlfY29sLCBwYXJfY29sO1xuICAgICAgICB2YXIgcGFyLCBzaGExO1xuXG4gICAgICAgIGlmKChpbmRleCA9IGJyYW5jaGVzLmluZGV4T2YoY29tbWl0LnNoYTEpKSA+IC0xKSB7XG4gICAgICAgICAgICBteV9jb2wgPSBpbmRleDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIG15X2NvbCA9IGdldF9mcmVlX2NvbHVtbigpO1xuICAgICAgICB9XG4gICAgICAgIHdoaWxlKChpbmRleCA9IGJyYW5jaGVzLmluZGV4T2YoY29tbWl0LnNoYTEpKSA+IC0xKSB7XG4gICAgICAgICAgICBicmFuY2hlc1tpbmRleF0gPSBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yKGk9MDsgbGVuID0gY29tbWl0LnBhcmVudHMubGVuZ3RoLCBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgICAgIHBhciA9IGNvbW1pdC5wYXJlbnRzW2ldO1xuXG4gICAgICAgICAgICBpZigoaW5kZXggPSBicmFuY2hlcy5pbmRleE9mKHBhcikpID4gLTEpIHtcbiAgICAgICAgICAgICAgICBpZigoYnJhbmNoZXNbbXlfY29sXSA9PSBudWxsKSlcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2JyYW5jaChwYXIsIG15X2NvbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZihsZW4gPT0gMSB8fCBpID09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gZG9udCBjcmVhdGUgbmV3IGJyYW5jaFxuICAgICAgICAgICAgICAgICAgICB1cGRhdGVfYnJhbmNoKHBhciwgbXlfY29sKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHBhcl9jb2wgPSBnZXRfZnJlZV9jb2x1bW4oKTtcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2JyYW5jaChwYXIsIHBhcl9jb2wpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbXlfY29sO1xuICAgIH1cblxuICAgIGZvcihfaT0wOyBfbGVuID0gZGF0YS5sZW5ndGgsIF9pIDwgX2xlbjsgX2krKykge1xuICAgICAgICB2YXIgY29tbWl0ID0gZGF0YVtfaV07XG4gICAgICAgIHZhciBwb3NpdGlvbiA9IHt9O1xuXG4gICAgICAgIHBvc2l0aW9uLmNvbHVtbiA9IGNyZWF0ZV9icmFuY2goY29tbWl0KTtcbiAgICAgICAgaWYocG9zaXRpb24uY29sdW1uID4gdGhpcy5tYXhfbGV2ZWwpXG4gICAgICAgICAgICB0aGlzLm1heF9jb2x1bW4gPSBwb3NpdGlvbi5jb2x1bW47XG4gICAgICAgIHBvc2l0aW9uLnJvdyA9IGN1cnJfcm93Kys7XG4gICAgICAgIGNvbW1pdC5wb3NpdGlvbiA9IHBvc2l0aW9uO1xuICAgfVxuICAgdGhpcy5tYXhfcm93ID0gY3Vycl9yb3c7XG59XG5cbkdpdEdyYXBoLnByb3RvdHlwZS5jb21taXRfc2VhcmNoID0gZnVuY3Rpb24oZGF0YSwgY29tbWl0KSB7XG4gICAgdmFyIGksIGxlbjtcbiAgICBmb3IoaT0wOyBsZW4gPSBkYXRhLmxlbmd0aCwgaSA8IGxlbjsgaSsrKSB7XG4gICAgICAgIGlmKGRhdGFbaV0uc2hhMSA9PT0gY29tbWl0KVxuICAgICAgICAgICAgcmV0dXJuIGk7XG4gICAgfVxufTtcblxuR2l0R3JhcGgucHJvdG90eXBlLmxpbmVzID0gZnVuY3Rpb24oZGF0YSkge1xuICAgIHZhciBjcmVhdGVfbWlkX3BvaW50ID0gZnVuY3Rpb24oc3RhcnQsIGVuZCwgaGVpZ2h0KSB7XG4gICAgICAgIHZhciBwb2ludCA9IHt9O1xuICAgICAgICBpZihzdGFydC54ID09IGVuZC54KSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZihzdGFydC54IDwgZW5kLngpIHtcbiAgICAgICAgICAgIHBvaW50LnggPSBlbmQueDtcbiAgICAgICAgICAgIHBvaW50LnkgPSBzdGFydC55ICsgaGVpZ2h0O1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcG9pbnQueCA9IHN0YXJ0Lng7XG4gICAgICAgICAgICBwb2ludC55ID0gZW5kLnkgLSBoZWlnaHQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHBvaW50O1xuICAgIH07XG5cbiAgICB2YXIgaSwgbGVuO1xuICAgIHZhciBoZWlnaHQgPSB0aGlzLmNvbmZpZy5jcm9zc19oZWlnaHQ7XG4gICAgdmFyIGNvbG9ycyA9IHRoaXMuY29uZmlnLmNvbG9yX2xpc3Q7XG4gICAgdmFyIGxpbmVfYXJyYXkgPSBbXTtcbiAgICB2YXIgbGluZV9jb2xvciA9IFtdO1xuICAgIGZvcihpPTA7IGxlbiA9IGRhdGEubGVuZ3RoLCBpIDwgbGVuOyBpKyspIHtcbiAgICAgICAgdmFyIGNvbW1pdCwgaiwgX2xlbjtcbiAgICAgICAgY29tbWl0ID0gZGF0YVtpXTtcbiAgICAgICAgLy8gYXNzaWduIGNvbG9yIGZvciBjb21taXRcbiAgICAgICAgaWYobGluZV9jb2xvcltjb21taXQucG9zaXRpb24uY29sdW1uXSA9PSBudWxsKSB7XG4gICAgICAgICAgICBjbHIgPSBjb2xvcnMuc2hpZnQoKTtcbiAgICAgICAgICAgIGNvbG9ycy5wdXNoKGNscik7XG4gICAgICAgICAgICBsaW5lX2NvbG9yW2NvbW1pdC5wb3NpdGlvbi5jb2x1bW5dID0gY2xyO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgY2xyID0gbGluZV9jb2xvcltjb21taXQucG9zaXRpb24uY29sdW1uXTtcbiAgICAgICAgfVxuICAgICAgICBjb21taXQucG9zaXRpb24uY29sb3IgPSBjbHI7XG5cbiAgICAgICAgZm9yKGo9MDsgX2xlbiA9IGNvbW1pdC5wYXJlbnRzLmxlbmd0aCwgaiA8IF9sZW47IGorKykge1xuICAgICAgICAgICAgdmFyIGxpbmUgPSBbXTtcbiAgICAgICAgICAgIHZhciBzdGFydCwgbWlkLCBlbmQsIGNscjtcbiAgICAgICAgICAgIHN0YXJ0PXt9OyBtaWQ9e307IGVuZD17fTtcblxuICAgICAgICAgICAgdmFyIGluZGV4ID0gdGhpcy5jb21taXRfc2VhcmNoKGRhdGEsIGNvbW1pdC5wYXJlbnRzW2pdKTtcbiAgICAgICAgICAgIHZhciBwYXJlbnQgPSBkYXRhW2luZGV4XTtcblxuICAgICAgICAgICAgc3RhcnQueCA9IGNvbW1pdC5wb3NpdGlvbi5jb2x1bW47XG4gICAgICAgICAgICBzdGFydC55ID0gY29tbWl0LnBvc2l0aW9uLnJvdztcbiAgICAgICAgICAgIGVuZC54ID0gcGFyZW50LnBvc2l0aW9uLmNvbHVtbjtcbiAgICAgICAgICAgIGVuZC55ID0gcGFyZW50LnBvc2l0aW9uLnJvdztcblxuICAgICAgICAgICAgaWYoc3RhcnQueCA8IGVuZC54KSB7XG5cbiAgICAgICAgICAgICAgICBtaWQueCA9IGVuZC54O1xuICAgICAgICAgICAgICAgIG1pZC55ID0gc3RhcnQueSArIGhlaWdodDtcbiAgICAgICAgICAgICAgICBjbHIgPSBjb2xvcnMuc2hpZnQoKTtcbiAgICAgICAgICAgICAgICBjb2xvcnMucHVzaChjbHIpO1xuXG4gICAgICAgICAgICAgICAgbGluZV9jb2xvcltlbmQueF0gPSBjbHI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmKHN0YXJ0LnggPiBlbmQueCkge1xuICAgICAgICAgICAgICAgIG1pZC54ID0gc3RhcnQueDtcbiAgICAgICAgICAgICAgICBtaWQueSA9IGVuZC55IC0gaGVpZ2h0O1xuICAgICAgICAgICAgICAgIGxpbmVfY29sb3Jbc3RhcnQueF0gPSBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3RhcnQuY29sb3IgPSBjbHI7XG4gICAgICAgICAgICBsaW5lLnB1c2goc3RhcnQpO1xuICAgICAgICAgICAgaWYoaXNfZW1wdHkobWlkKSA9PSBmYWxzZSlcbiAgICAgICAgICAgICAgICBsaW5lLnB1c2gobWlkKTtcbiAgICAgICAgICAgIGxpbmUucHVzaChlbmQpO1xuICAgICAgICAgICAgbGluZV9hcnJheS5wdXNoKGxpbmUpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBsaW5lX2FycmF5O1xufTtcblxuR2l0R3JhcGgucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKGxvY2F0aW9uLCBkYXRhKSB7XG4gICAgdmFyIGxpbmVfYXJyYXkgPSB0aGlzLmxpbmVzKGRhdGEpO1xuICAgIHZhciBzZWxmID0gdGhpcztcblxuICAgIHZhciBjcmVhdGVfbGluZSA9IGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgdmFyIHgsIHksIHBvaW50X25vO1xuICAgICAgICB2YXIgbGluZTtcbiAgICAgICAgcG9pbnRfbm8gPSAxO1xuICAgICAgICBmb3IodmFyIGk9MDsgbGVuID0gZC5sZW5ndGgsIGkgPCBsZW47IGkrKykge1xuICAgICAgICAgICAgeCA9IHNlbGYuY29uZmlnLmxlZnRfbWFyZ2luICsgKGRbaV0ueCAqIHNlbGYuY29uZmlnLmJyYW5jaF9zcGFjaW5nKTtcbiAgICAgICAgICAgIHkgPSBzZWxmLmNvbmZpZy50b3BfbWFyZ2luICsgKGRbaV0ueSAqIHNlbGYuY29uZmlnLmNpcmNsZV9zcGFjaW5nKVxuICAgICAgICAgICAgaWYocG9pbnRfbm8gPT0gMSkge1xuICAgICAgICAgICAgICAgIGxpbmUgPSBcIk1cIiArIHggKyAnLCcgKyB5O1xuICAgICAgICAgICAgICAgIHBvaW50X25vKys7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBsaW5lKz0gXCJMXCIgKyB4ICsgJywnICsgeTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbGluZTtcbiAgICB9O1xuXG4gICAgdmFyIGNyZWF0ZV9lbGVtZW50ID0gZnVuY3Rpb24odHlwZSkge1xuICAgICAgICByZXR1cm4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKFwiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmdcIiwgdHlwZSk7XG4gICAgfTtcblxuICAgIHZhciBoZWlnaHQgPSB0aGlzLmNvbmZpZy50b3BfbWFyZ2luICsgdGhpcy5tYXhfcm93ICogdGhpcy5jb25maWcuY2lyY2xlX3NwYWNpbmc7XG5cbiAgICB2YXIgc3ZnID0gY3JlYXRlX2VsZW1lbnQoXCJzdmdcIik7XG5cbiAgICB2YXIgbGluZV9ncm91cCA9IHN2Zy5hcHBlbmRDaGlsZChjcmVhdGVfZWxlbWVudChcImdcIikpO1xuICAgIHZhciBjaXJjbGVfZ3JvdXAgPSBzdmcuYXBwZW5kQ2hpbGQoY3JlYXRlX2VsZW1lbnQoXCJnXCIpKTtcblxuICAgIGNpcmNsZV9ncm91cC5zZXRBdHRyaWJ1dGUoXCJzdG9rZS13aWR0aFwiLCBzZWxmLmNvbmZpZy5jaXJjbGUuc3Ryb2tlKTtcbiAgICBjaXJjbGVfZ3JvdXAuc2V0QXR0cmlidXRlKFwic3Ryb2tlXCIsIFwiIzAwMFwiKTtcblxuICAgIGRhdGEuZm9yRWFjaChmdW5jdGlvbihkKSB7XG4gICAgICAgIHZhciBjaXJjbGUgPSBjaXJjbGVfZ3JvdXAuYXBwZW5kQ2hpbGQoY3JlYXRlX2VsZW1lbnQoXCJjaXJjbGVcIikpO1xuICAgICAgICBjaXJjbGUuc2V0QXR0cmlidXRlKFwiY3hcIiwgKHNlbGYuY29uZmlnLmxlZnRfbWFyZ2luICsgKGQucG9zaXRpb24uY29sdW1uICogc2VsZi5jb25maWcuYnJhbmNoX3NwYWNpbmcpKSk7XG4gICAgICAgIGNpcmNsZS5zZXRBdHRyaWJ1dGUoXCJjeVwiLCAoc2VsZi5jb25maWcudG9wX21hcmdpbiArIChkLnBvc2l0aW9uLnJvdyAqIHNlbGYuY29uZmlnLmNpcmNsZV9zcGFjaW5nKSkpO1xuICAgICAgICBjaXJjbGUuc2V0QXR0cmlidXRlKFwiclwiLCBzZWxmLmNvbmZpZy5jaXJjbGUucmFkaXVzKTtcbiAgICAgICAgY2lyY2xlLnNldEF0dHJpYnV0ZShcImZpbGxcIiwgZC5wb3NpdGlvbi5jb2xvcik7XG4gICAgfSlcblxuICAgIGxpbmVfZ3JvdXAuc2V0QXR0cmlidXRlKFwic3Ryb2tlXCIsIFwiIzAwMFwiKTtcbiAgICBsaW5lX2dyb3VwLnNldEF0dHJpYnV0ZShcInN0cm9rZS13aWR0aFwiLCB0aGlzLmNvbmZpZy5saW5lX3dpZHRoKTtcbiAgICBsaW5lX2dyb3VwLnNldEF0dHJpYnV0ZShcImZpbGxcIiwgXCJub25lXCIpO1xuXG5cbiAgICBsaW5lX2FycmF5LmZvckVhY2goZnVuY3Rpb24oZCkge1xuICAgICAgICB2YXIgcGF0aCA9IGxpbmVfZ3JvdXAuYXBwZW5kQ2hpbGQoY3JlYXRlX2VsZW1lbnQoXCJwYXRoXCIpKTtcbiAgICAgICAgcGF0aC5zZXRBdHRyaWJ1dGUoXCJkXCIsIGNyZWF0ZV9saW5lKGQpKTtcbiAgICAgICAgcGF0aC5zZXRBdHRyaWJ1dGUoXCJzdHJva2VcIiwgZFswXS5jb2xvcik7XG4gICAgfSlcblxuICAgIGxvY2F0aW9uLmFwcGVuZChzdmcpO1xuICAgIHN2Zy5zZXRBdHRyaWJ1dGUoXCJ3aWR0aFwiLCBzdmcuY2hpbGROb2Rlc1sxXS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aCArIHRoaXMuY29uZmlnLmxlZnRfbWFyZ2luKTtcbiAgICBzdmcuc2V0QXR0cmlidXRlKFwiaGVpZ2h0XCIsIGhlaWdodCk7XG4gICAgcmV0dXJuIHN2Zztcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gR2l0R3JhcGg7XG4iXX0=